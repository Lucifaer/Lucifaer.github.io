<!DOCTYPE html>
<html>
    <!-- title -->




<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" >
    <meta name="author" content="Lucifaer">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="Lucifaer">
    <meta name="keywords" content="Lucifaer's blog | Lucifaer">
    <meta name="description" content="Some Lucifaer's security researchers and security analysis">
    <meta name="Cache-Control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="google-site-verification" content="LjYNGqlZPALnNPPyA_Uvw22OVRlDOw2RInQz8sZX-Yk" />
    <title>浅谈RASP · Lucifaer&#39;s Blog</title>
    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s 1;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }

</style>

    <link rel="preload" href= /css/style.css?v=20180721 as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <link rel="stylesheet" href= /css/mobile.css?v=20180721 media="(max-width: 980px)">
    
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
(function( w ){
	"use strict";
	// rel=preload support test
	if( !w.loadCSS ){
		w.loadCSS = function(){};
	}
	// define on the loadCSS obj
	var rp = loadCSS.relpreload = {};
	// rel=preload feature support test
	// runs once and returns a function for compat purposes
	rp.support = (function(){
		var ret;
		try {
			ret = w.document.createElement( "link" ).relList.supports( "preload" );
		} catch (e) {
			ret = false;
		}
		return function(){
			return ret;
		};
	})();

	// if preload isn't supported, get an asynchronous load by using a non-matching media attribute
	// then change that media back to its intended value on load
	rp.bindMediaToggle = function( link ){
		// remember existing media attr for ultimate state, or default to 'all'
		var finalMedia = link.media || "all";

		function enableStylesheet(){
			link.media = finalMedia;
		}

		// bind load handlers to enable media
		if( link.addEventListener ){
			link.addEventListener( "load", enableStylesheet );
		} else if( link.attachEvent ){
			link.attachEvent( "onload", enableStylesheet );
		}

		// Set rel and non-applicable media type to start an async request
		// note: timeout allows this to happen async to let rendering continue in IE
		setTimeout(function(){
			link.rel = "stylesheet";
			link.media = "only x";
		});
		// also enable media after 3 seconds,
		// which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
		setTimeout( enableStylesheet, 3000 );
	};

	// loop through link elements in DOM
	rp.poly = function(){
		// double check this to prevent external calls from running
		if( rp.support() ){
			return;
		}
		var links = w.document.getElementsByTagName( "link" );
		for( var i = 0; i < links.length; i++ ){
			var link = links[ i ];
			// qualify links to those with rel=preload and as=style attrs
			if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
				// prevent rerunning on link
				link.setAttribute( "data-loadcss", true );
				// bind listeners to toggle media back
				rp.bindMediaToggle( link );
			}
		}
	};

	// if unsupported, run the polyfill
	if( !rp.support() ){
		// run once at least
		rp.poly();

		// rerun poly on an interval until onload
		var run = w.setInterval( rp.poly, 500 );
		if( w.addEventListener ){
			w.addEventListener( "load", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		} else if( w.attachEvent ){
			w.attachEvent( "onload", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		}
	}


	// commonjs
	if( typeof exports !== "undefined" ){
		exports.loadCSS = loadCSS;
	}
	else {
		w.loadCSS = loadCSS;
	}
}( typeof global !== "undefined" ? global : this ) );
</script>

    <link rel="icon" href= "/assets/favicon.ico" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js" as="script" />
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" as="script" />
    <link rel="preload" href="/scripts/main.js" as="script" />
    <link rel="preload" as="font" href="/font/Oswald-Regular.ttf" crossorigin>
    <link rel="preload" as="font" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" crossorigin>
    
        <!-- algolia -->
        <script>
            
            var hits = JSON.parse('{"per_page":10}')
            var labels = JSON.parse('{"input_placeholder":"Search for Posts","hits_empty":"We did not find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}')

            var algolia = {
                applicationID: 'K0XKT0INON',
                apiKey: 'cc8e96eb9aa249bbd7662f7f8f7d70ca',
                indexName: 'blog',
                hits: hits,
                labels: labels
            }
        </script>
    
    <!-- fancybox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script>
    <!-- 百度统计  -->
    
    <!-- 谷歌统计  -->
    
</head>

    
        <body class="post-body">
    
    
<header class="header">

    <div class="read-progress"></div>
    <div class="header-sidebar-menu">&#xe775;</div>
    <!-- post页的toggle banner  -->
    
    <div class="banner">
            <div class="blog-title">
                <a href="/" >Lucifaer&#39;s Blog.</a>
            </div>
            <div class="post-title">
                <a href="#" class="post-name">浅谈RASP</a>
            </div>
    </div>
    
    <a class="home-link" href=/>Lucifaer's Blog.</a>
</header>
    <div class="wrapper">
        <div class="site-intro" style=








height:50vh;

>
    
    <!-- 主页  -->
    
    
    <!-- 404页  -->
            
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.jpg)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
            浅谈RASP
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
            
            <!-- 404 -->
            
        </p>
        <!-- 文章页meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                    <div class= post-intro-tags >
    
        <a class="post-tag" href="javascript:void(0);" data-tags = "安全研究">安全研究</a>
    
</div>
                
                
                    <div class="post-intro-read">
                        <span>Word count: <span class="post-count">9,071</span> / Reading time: <span class="post-count">35 min</span></span>
                    </div>
                
                <div class="post-intro-meta">
                    <span class="post-intro-calander iconfont-archer">&#xe676;</span>
                    <span class="post-intro-time">2019/09/25</span>
                    
                    <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                        <span class="iconfont-archer">&#xe602;</span>
                        <span id="busuanzi_value_page_pv"></span>
                    </span>
                    
                    <span class="shareWrapper">
                        <span class="iconfont-archer shareIcon">&#xe71d;</span>
                        <span class="shareText">Share</span>
                        <ul class="shareList">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
        
    </div>
</div>
        <script>
 
  // get user agent
  var browser = {
    versions: function () {
      var u = window.navigator.userAgent;
      return {
        userAgent: u,
        trident: u.indexOf('Trident') > -1, //IE内核
        presto: u.indexOf('Presto') > -1, //opera内核
        webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
        gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
        mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
        ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
        android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
        iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
        iPad: u.indexOf('iPad') > -1, //是否为iPad
        webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
        weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
        uc: u.indexOf('UCBrowser') > -1 //是否为android下的UC浏览器
      };
    }()
  }
  console.log("userAgent:" + browser.versions.userAgent);

  // callback
  function fontLoaded() {
    console.log('font loaded');
    if (document.getElementsByClassName('site-intro-meta')) {
      document.getElementsByClassName('intro-title')[0].classList.add('intro-fade-in');
      document.getElementsByClassName('intro-subtitle')[0].classList.add('intro-fade-in');
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in');
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb(){
    if (browser.versions.uc) {
      console.log("UCBrowser");
      fontLoaded();
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular']
        },
        loading: function () {  //所有字体开始加载
          // console.log('loading');
        },
        active: function () {  //所有字体已渲染
          fontLoaded();
        },
        inactive: function () { //字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout');
          fontLoaded();
        },
        timeout: 5000 // Set the timeout to two seconds
      });
    }
  }

  function asyncErr(){
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (cb) { o.addEventListener('load', function (e) { cb(null, e); }, false); }
    if (err) { o.addEventListener('error', function (e) { err(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }

  var asyncLoadWithFallBack = function(arr, success, reject) {
      var currReject = function(){
        reject()
        arr.shift()
        if(arr.length)
          async(arr[0], success, currReject)
        }

      async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack([
    "https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js", 
    "https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js",
    "/lib/webfontloader.min.js"
  ], asyncCb, asyncErr)
</script>        
        <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
        <div class="container container-unloaded">
            <main class="main post-page">
    <article class="article-entry">
        <p>本篇将近一个月对rasp的研究成果进行汇总，具体讨论RASP的优劣势以及一些个人的理解和看法。</p>
<a id="more"></a>
<h1 id="0x01-概述"><a href="#0x01-概述" class="headerlink" title="0x01 概述"></a>0x01 概述</h1><p>RASP是<code>Runtime application self-protection</code>的缩写，中文翻译为应用程序运行时防护，其与WAF等传统安全防护措施的主要区别于其防护层级更加底层——在功能调用前或调用时能获取访问到当前方法的参数等信息，根据这些信息来判定是否安全。</p>
<p>RASP与传统的基于流量监测的安全防护产品来说，优势点在于<strong>可以忽略各种绕过流量检测的攻击方式（如分段传输，编码等），只关注功能运行时的传参是否会产生安全威胁。简单来说，RASP不看过程，只看具体参数导致方法实现时是否会产生安全威胁。</strong>简单类比一下，RASP就相当于应用程序的主防，其判断是更加精准的。</p>
<p>虽然RASP有很多优势，但是由于其本身的实现也导致了很多问题使其难以推广：</p>
<ul>
<li>侵入性过大。对于JAVA的RASP来说，它的实现方式是通过<code>Instrumentation</code>编写一个agent，在agent中加入hook点，当程序运行流程到了hook点时，将检测流程插入到字节码文件中，统一进入JVM中执行。在这里如果RASP本身出现了什么问题的话，将会直接对业务造成影响。</li>
<li>效率问题。由于需要将检测流程插入到字节码文件中，这样会在运行时产生大量不属于业务流程本身的逻辑，这样会增加业务执行的流程，对业务效率造成一定的影响。</li>
<li>开发问题。针对不同的语言，RASP底层的实现是不一样的，都需要重新基于语言特性进行专门的开发，开发的压力很大。</li>
<li>部署问题。以Java RASP来举例子，Java RASP有两种部署方式，一种需要在启动前指定agent的位置，另一种可以在运行时用attach的方式进行部署，但是他们都存在不同的问题。<ul>
<li>在启动前指定agent的位置就以为着在进行部署时需要重启服务，会影响到正常的业务。</li>
<li>在运行时进行attach部署时，当后期RASP进行版本迭代重新attach时，会产生重复添加代码的情况（由于JVM本身机制的问题，基本无法将修改的字节码重新转换到运行时的字节码上，所以没办法动态添加代理解决该问题）。</li>
</ul>
</li>
</ul>
<p>目前RASP的主方向还是Java RASP，受益于JVMTI，现在的Java RASP是很好编写的，效果也是比较错的。同时也受限于JVMTI，Java RASP的技术栈受到了一定的限制，很难在具体实现上更进一步，只能在hook点和其他功能上进行完善。</p>
<p>跳出乙方视角来审视RASP，其最好的实践场景还是在<strong>甲方企业内部</strong>，从某个角度来说RASP本来就是高度侵入业务方代码的一种防护措施，在纷繁复杂的业务场景中，只有甲方根据业务进行定制化开发才能达到RASP的最高价值，如果乙方来做很容易变成“纸上谈兵”的产品。</p>
<p>下面将以Java RASP为核心对RASP技术进行详细的阐述，并用跟踪源码的方式来解析百度OpenRASP的具体实现方式。</p>
<h1 id="0x02-Java-RASP技术栈"><a href="#0x02-Java-RASP技术栈" class="headerlink" title="0x02 Java RASP技术栈"></a>0x02 Java RASP技术栈</h1><p>Java RASP核心技术栈：</p>
<ul>
<li><code>Instrumentation</code>通过JVMTI实现的Agent，负责获取并返回当前JVM虚拟机的状态或转发控制命令。</li>
<li>字节码操作框架，用于修改字节码（如ASM、Javassist等）</li>
</ul>
<p>其余技术栈：</p>
<ul>
<li>Log4j日志记录</li>
<li>插件系统（主要是用于加载检测规则）</li>
<li>数据存储及转发（转发到soc平台或自动封禁平台进行封禁）<br>等</li>
</ul>
<h1 id="0x03-Java-RASP实现方式"><a href="#0x03-Java-RASP实现方式" class="headerlink" title="0x03 Java RASP实现方式"></a>0x03 Java RASP实现方式</h1><p>编写Java RASP主要分为两部分：</p>
<ul>
<li><code>Java Agent</code>的编写</li>
<li>利用字节码操作框架（以下都以ASM来举例）完成相应hook操作</li>
</ul>
<h2 id="3-1-Java-Agent简介"><a href="#3-1-Java-Agent简介" class="headerlink" title="3.1 Java Agent简介"></a>3.1 Java Agent简介</h2><p>在Java SE 5及后续版本中，开发者可以在一个普通Java程序运行时，通过<code>-javaagent</code>参数指定一个特定的<code>jar</code>文件（该文件包含<code>Instrumentation</code>代理）来启动<code>Instrumentation</code>的代理程序，这个代理程序可以使开发者获取并访问JVM运行时的字节码，并提供了对字节码进行编辑的操作，这就意味着开发者可以将自己的代码注入，在运行时完成相应的操作。在Java SE 6后又对改功能进行了增强，允许开发者以用Java Tool API中的attach的方式在程序运行中动态的设置代理类，以达到<code>Instrumentation</code>的目的。而这两个特性也是编写Java RASP的关键。</p>
<p><code>javaagent</code>提供了两种模式：</p>
<ul>
<li><code>premain</code>：允许在main开始前修改字节码，也就是在<strong>大部分类加载前</strong>对字节码进行修改。</li>
<li><code>agentmain</code>：允许在main执行后通过<code>com.sun.tools.attach</code>的Attach API attach到程序运行时中，通过<code>retransform</code>的方式修改字节码，也就是在<strong>类加载后通过类重新转换（定义）的方式在方法体中</strong>对字节码进行修改，<strong>其本质还是在类加载前对字节码进行修改</strong>。</li>
</ul>
<p>这两种模式除了在<code>main</code>开始前后调用的区别外，还有很多细枝末节的区别，这一点就导致了两种模式的泛用性不同：</p>
<ul>
<li>agent运作模式不同：<code>premain</code>相当于在main前类加载时进行字节码修改，<code>agentmain</code>是main后在类调用前通过重新转换类完成字节码修改。可以发现他们的本质都是在类加载前完成的字节码修改，但是<code>premain</code>可以直接修改或者通过<code>redefined</code>进行类重定义，而<code>agentmian</code>必须通过<code>retransform</code>进行类重新转换才能完成字节码修改操作。</li>
<li>部署方式不同：由于agent运作模式的不同，所以才导致<code>premain</code>需要在程序启动前指定agent，而<code>agentmain</code>需要通过Attach API进行attach。而且由于都是在类加载前进行字节码的修改，所以<strong>如果<code>premain</code>模式的hook进行了更新，就只能重启服务器，而<code>agentmain</code>模式的hook如果进行了更新的话，需要重新attach</strong>。</li>
</ul>
<p>因为两种模式都存在一定的限制，所以在实际运用中都会有相应的问题：</p>
<ul>
<li><code>premain</code>：每次修改需要重启服务。</li>
<li><p><code>agentmain</code>：由于attach的运行时中的进程，因JVM的进程保护机制，禁止在程序运行时对运行时的类进行自由的修改，具体的限制如下：</p>
<ul>
<li>父类应为同一个类</li>
<li>实现的接口数要相同</li>
<li>类访问符要一致</li>
<li>字段数和字段名必须一致</li>
<li>新增的方法必须是<code>private static/final</code>的</li>
<li><p>可是删除修改方法</p>
<p>这样的限制是没有办法用代理模式的思路来避免重复插入的。同时为了实现增加hook点的操作我们必须将自己的检测字节码插入，所以只能修改方法体。这样一来如果使用<code>agentmain</code>进行重复的attach，会造成将相同代码多次插入的操作，会产生重复告警，极大的增加业务压力。</p>
</li>
</ul>
</li>
</ul>
<p>单单针对<code>agentmain</code>所出现的重复插入的问题，有没有方式能直接对运行时的java类做字节码插入呢？其实是有的，但是由于各种原因，其会较大的增加业务压力所以这里不过多叙述，想要了解详情的读者，可以通过搜索<code>Hotswap</code>和<code>DCE VM</code>来了解两种不同的热部署方式。</p>
<h2 id="3-2-ASM简介"><a href="#3-2-ASM简介" class="headerlink" title="3.2 ASM简介"></a>3.2 ASM简介</h2><p>ASM是一个Java字节码操作框架，它主要是基于访问者模式对字节码完成相应的增删改操作。想要深入的理解ASM可以去仔细阅读<a href="https://asm.ow2.io/asm4-guide.pdf" target="_blank" rel="noopener">ASM的官方文档</a>，这里只是简单的介绍一下ASM的用法。</p>
<p>在开始讲ASM用法前，需要简单的介绍一下访问者模式，只有清楚的访问者模式，才能理解ASM为什么要这么写。</p>
<h4 id="3-2-1-访问者模式"><a href="#3-2-1-访问者模式" class="headerlink" title="3.2.1 访问者模式"></a>3.2.1 访问者模式</h4><p>在面向对象编程和软件工程中，访问者模式是一种把数据结构和操作这个数据结构的算法分开的模式。这种分离能方便的添加新的操作而无需更改数据结构。</p>
<p>实质上，访问者允许一个类族添加新的虚函数而不修改类本身。但是，创建一个访问者类可以实现虚函数所有的特性。访问者接收实例引用作为输入，使用双重调用实现这个目标。</p>
<p>上面说的的比较笼统，直接用代码来说话：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lucifaer.ASMDemo;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor v)</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Play</span> <span class="keyword">implements</span> <span class="title">Person</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">accept</span><span class="params">(Visitor v)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        v.visit(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">play</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        System.out.println(<span class="string">"This is Person's Play!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Visitor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(Play p)</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonVisitor</span> <span class="keyword">implements</span> <span class="title">Visitor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(Play p)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"In Visitor!"</span>);</span><br><span class="line">        <span class="keyword">long</span> start_time = System.currentTimeMillis();</span><br><span class="line">        p.play();</span><br><span class="line">        <span class="keyword">long</span> end_time = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"End Visitor"</span>);</span><br><span class="line">        System.out.println(<span class="string">"Spend time: "</span> + (end_time-start_time));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VisiterMod</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Person p = <span class="keyword">new</span> Play();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        PersonVisitor pv = <span class="keyword">new</span> PersonVisitor();</span><br><span class="line">        p.accept(pv);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个例子中做了以下的工作:</p>
<ol>
<li>添加<code>void accept(Visitor v)</code>到<code>Person</code>类中</li>
<li>创建visitor基类，基类中包含元素类的<code>visit()</code>方法</li>
<li>创建visitor派生类，实现基类对<code>Person</code>的<code>Play</code>的操作</li>
<li>使用者创建visitor对象，调用元素的accept方法并传递visitor实例作为参数</li>
</ol>
<p>可以看到在没有改变数据结构的情况下只是实现了Visitor类就可以在visit方法中自行加入代码实现自定义逻辑，而不会影响到原本Person接口的实现类。</p>
<p>结果为：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15689648468141.jpg" alt=""></p>
<h4 id="3-2-2-ASM的访问者模式"><a href="#3-2-2-ASM的访问者模式" class="headerlink" title="3.2.2 ASM的访问者模式"></a>3.2.2 ASM的访问者模式</h4><p>在ASM中的访问者模式中，<code>ClassReader</code>类和<code>MethodNode</code>类都是被访问的类，访问者接口包括：<code>ClassVistor</code>、<code>AnnotationVisitor</code>、<code>FieldVistor</code>和<code>MethodVistor</code>。访问者接口的方法集以及优先顺序可以在下图中进行查询：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15689714569539.jpg" alt=""></p>
<p>通过该图可以清晰的看出调用顺序，对于新手来说可以简单的理解为下面这样的调用顺序：</p>
<ul>
<li>需要访问类，所以要声明<code>ClassReader</code>，来“获取”类。</li>
<li>如果需要对类中的内容进行修改，就需要声明<code>ClassWriter</code>它是继承于<code>ClassReader</code>的。</li>
<li><p>然后实例化“访问者”<code>ClassVisitor</code>来进行类访问，至此就以“访问者”的身份进入了类，你可以进行以下工作：</p>
<ul>
<li>如果需要访问注解，则实例化<code>AnnotationVisitor</code></li>
<li>如果需要访问参数，则实例化<code>FieldVisitor</code></li>
<li><p>如果需要访问方法，则实例化<code>MethodVisitro</code></p>
<p>每种访问其内部的访问顺序可以在图上自行了解。</p>
</li>
</ul>
</li>
<li><code>ClassReader</code>调用<code>accept</code>方法</li>
<li>完成整个调用流程</li>
</ul>
<h2 id="3-3-实际例子"><a href="#3-3-实际例子" class="headerlink" title="3.3 实际例子"></a>3.3 实际例子</h2><p>在具体展示两种模式的例子前，先补充一下agent的运行条件，无论用那种模式写出来的agent，都需要将agent打成jar包，同时在jar包中应用<code>META-INF/MANIFEST.MF</code>中指定agent的相关信息，下面是个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Can-Redefine-Classes: true</span><br><span class="line">Can-Retransform-Classes: true</span><br><span class="line">Premain-Class: com.lucifaer.javaagentLearning.agent.PreMainTranceAgent</span><br><span class="line">Agent-Class: com.lucifaer.javaagentLearning.agent.AgentMainTranceAgent</span><br></pre></td></tr></table></figure>
<p><code>Premain-Class</code>和<code>Agent-Class</code>是用来配置不同模式的agent实现类，<code>Can-Redefine-Classes</code>和<code>Can-Retransform-Classes</code>是用来指示是否允许进行类重定义和类重新转换，这两个参数在一定的情况下决定了是否能在agent中利用ASM对加载的类进行修改。</p>
<h3 id="3-3-1-premain模式例子"><a href="#3-3-1-premain模式例子" class="headerlink" title="3.3.1 premain模式例子"></a>3.3.1 premain模式例子</h3><p>下面用园长的一个demo来展示如何利用<code>premain</code>方式进行表达式监控。完整代码可以看<a href="https://github.com/anbai-inc/javaweb-expression" target="_blank" rel="noopener">这里</a>，也可以看我<a href="https://github.com/Lucifaer/head_first_javarasp/tree/el_expression_hook" target="_blank" rel="noopener">整理后的代码</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Agent</span> <span class="keyword">implements</span> <span class="title">Opcodes</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;MethodHookDesc&gt; expClassList = <span class="keyword">new</span> ArrayList&lt;MethodHookDesc&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        expClassList.add(<span class="keyword">new</span> MethodHookDesc(<span class="string">"org.mvel2.MVELInterpretedRuntime"</span>, <span class="string">"parse"</span>,</span><br><span class="line">                <span class="string">"()Ljava/lang/Object;"</span>));</span><br><span class="line">        expClassList.add(<span class="keyword">new</span> MethodHookDesc(<span class="string">"ognl.Ognl"</span>, <span class="string">"parseExpression"</span>,</span><br><span class="line">                <span class="string">"(Ljava/lang/String;)Ljava/lang/Object;"</span>));</span><br><span class="line">        expClassList.add(<span class="keyword">new</span> MethodHookDesc(<span class="string">"org.springframework.expression.spel.standard.SpelExpression"</span>, <span class="string">"&lt;init&gt;"</span>,</span><br><span class="line">                <span class="string">"(Ljava/lang/String;Lorg/springframework/expression/spel/ast/SpelNodeImpl;"</span> +</span><br><span class="line">                        <span class="string">"Lorg/springframework/expression/spel/SpelParserConfiguration;)V"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">premain</span><span class="params">(String agentArgs, Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"agentArgs : "</span> + agentArgs);</span><br><span class="line">        instrumentation.addTransformer(<span class="keyword">new</span> ClassFileTransformer() &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line">                <span class="keyword">final</span> String class_name = className.replace(<span class="string">"/"</span>, <span class="string">"."</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">final</span> MethodHookDesc methodHookDesc : expClassList) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (methodHookDesc.getHookClassName().equals(class_name)) &#123;</span><br><span class="line">                        <span class="keyword">final</span> ClassReader classReader = <span class="keyword">new</span> ClassReader(classfileBuffer);</span><br><span class="line">                        ClassWriter classWriter = <span class="keyword">new</span> ClassWriter(classReader, ClassWriter.COMPUTE_MAXS);</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> api = ASM5;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            ClassVisitor classVisitor = <span class="keyword">new</span> ClassVisitor(api, classWriter) &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> i, String s, String s1, String s2, String[] strings)</span> </span>&#123;</span><br><span class="line">                                    <span class="keyword">final</span> MethodVisitor methodVisitor = <span class="keyword">super</span>.visitMethod(i, s, s1, s2, strings);</span><br><span class="line"></span><br><span class="line">                                    <span class="keyword">if</span> (methodHookDesc.getHookMethodName().equals(s) &amp;&amp; methodHookDesc.getHookMethodArgTypeDesc().equals(s1)) &#123;</span><br><span class="line">                                        <span class="keyword">return</span> <span class="keyword">new</span> MethodVisitor(api, methodVisitor) &#123;</span><br><span class="line">                                            <span class="meta">@Override</span></span><br><span class="line">                                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                                <span class="keyword">if</span> (<span class="string">"ognl.Ognl"</span>.equals(class_name)) &#123;</span><br><span class="line">                                                    methodVisitor.visitVarInsn(Opcodes.ALOAD, <span class="number">0</span>);</span><br><span class="line">                                                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                                                    methodVisitor.visitVarInsn(Opcodes.ALOAD, <span class="number">1</span>);</span><br><span class="line">                                                &#125;</span><br><span class="line">                                                methodVisitor.visitMethodInsn(</span><br><span class="line">                                                        Opcodes.INVOKESTATIC, Agent.class.getName().replace(<span class="string">"."</span>, <span class="string">"/"</span>), <span class="string">"expression"</span>, <span class="string">"(Ljava/lang/String;)V"</span>, <span class="keyword">false</span></span><br><span class="line">                                                );</span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                    <span class="keyword">return</span> methodVisitor;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;;</span><br><span class="line">                            classReader.accept(classVisitor, ClassReader.EXPAND_FRAMES);</span><br><span class="line">                            classfileBuffer = classWriter.toByteArray();</span><br><span class="line">                        &#125;<span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                            t.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> classfileBuffer;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">expression</span><span class="params">(String exp_demo)</span> </span>&#123;</span><br><span class="line">        System.err.println(<span class="string">"---------------------------------EXP-----------------------------------------"</span>);</span><br><span class="line">        System.err.println(exp_demo);</span><br><span class="line">        System.err.println(<span class="string">"---------------------------------调用链---------------------------------------"</span>);</span><br><span class="line"></span><br><span class="line">        StackTraceElement[] elements = Thread.currentThread().getStackTrace();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (StackTraceElement element : elements) &#123;</span><br><span class="line">            System.err.println(element);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.err.println(<span class="string">"-----------------------------------------------------------------------------"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里采用的是流式写法，没有将其中的<code>ClassFileTransformer</code>抽出来。</p>
<p>整个流程简化如下：</p>
<ul>
<li>根据<code>className</code>来判断当前agent拦截的类是否是需要hook的类，如果是，则直接进入ASM修改流程。</li>
<li>在<code>ClassVisitor</code>中调用<code>visitMethod</code>方法去访问hook类中的每个方法，根据方法名判断当前的方法是否是需要hook的方法，如果是，则调用<code>visitCode</code>方法在访问具体代码时获取方法的相关参数（这里是获取表达式），并在执行逻辑中插入<code>expression</code>方法的调用，在运行时将执行流经过新添加的方法，就可以打印出表达式以及调用链了。</li>
</ul>
<p>效果如下：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15682851340114.jpg" alt=""></p>
<h3 id="3-3-2-agentmain模式例子"><a href="#3-3-2-agentmain模式例子" class="headerlink" title="3.3.2 agentmain模式例子"></a>3.3.2 agentmain模式例子</h3><p>下面用一个我自己写的例子来说一下如何利用agentmain模式增加执行流。</p>
<blockquote>
<p>AgentMain.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgentMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">agentmain</span><span class="params">(String agentArgs, Instrumentation inst)</span> <span class="keyword">throws</span> UnmodifiableClassException </span>&#123;</span><br><span class="line"><span class="comment">//        for (Class clazz : inst.getAllLoadedClasses()) &#123;</span></span><br><span class="line"><span class="comment">//            System.out.println(clazz.getName());</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        CustomClassTransformer transformer = <span class="keyword">new</span> CustomClassTransformer(inst);</span><br><span class="line">        transformer.retransform();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>CustomClassTransformer.java</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomClassTransformer</span> <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Instrumentation inst;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomClassTransformer</span><span class="params">(Instrumentation inst)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.inst = inst;</span><br><span class="line">        inst.addTransformer(<span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line">        System.out.println(<span class="string">"In Transform"</span>);</span><br><span class="line">        ClassReader cr = <span class="keyword">new</span> ClassReader(classfileBuffer);</span><br><span class="line">        ClassWriter cw = <span class="keyword">new</span> ClassWriter(cr, ClassWriter.COMPUTE_MAXS);</span><br><span class="line">        ClassVisitor cv = <span class="keyword">new</span> ClassVisitor(Opcodes.ASM5, cw) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> i, String s, String s1, String s2, String[] strings)</span> </span>&#123;</span><br><span class="line"><span class="comment">//                return super.visitMethod(i, s, s1, s2, strings);</span></span><br><span class="line">                <span class="keyword">final</span> MethodVisitor mv = <span class="keyword">super</span>.visitMethod(i, s, s1, s2, strings);</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"say"</span>.equals(s)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> MethodVisitor(Opcodes.ASM5, mv) &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">super</span>.visitCode();</span><br><span class="line">                            mv.visitFieldInsn(Opcodes.GETSTATIC, <span class="string">"java/lang/System"</span>, <span class="string">"out"</span>, <span class="string">"Ljava/io/PrintStream;"</span>);</span><br><span class="line">                            mv.visitLdcInsn(<span class="string">"CALL "</span> + <span class="string">"method"</span>);</span><br><span class="line">                            mv.visitMethodInsn(Opcodes.INVOKEVIRTUAL, <span class="string">"java/io/PrintStream"</span>, <span class="string">"println"</span>, <span class="string">"(Ljava/lang/String;)V"</span>, <span class="keyword">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> mv;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        cr.accept(cv, ClassReader.EXPAND_FRAMES);</span><br><span class="line">        classfileBuffer = cw.toByteArray();</span><br><span class="line">        <span class="keyword">return</span> classfileBuffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">retransform</span><span class="params">()</span> <span class="keyword">throws</span> UnmodifiableClassException </span>&#123;</span><br><span class="line">        LinkedList&lt;Class&gt; retransformClasses = <span class="keyword">new</span> LinkedList&lt;Class&gt;();</span><br><span class="line">        Class[] loadedClasses = inst.getAllLoadedClasses();</span><br><span class="line">        <span class="keyword">for</span> (Class clazz : loadedClasses) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"com.lucifaer.test_agentmain.TestAgentMain"</span>.equals(clazz.getName())) &#123;</span><br><span class="line">                <span class="keyword">if</span> (inst.isModifiableClass(clazz) &amp;&amp; !clazz.getName().startsWith(<span class="string">"java.lang.invoke.LambdaForm"</span>)) &#123;</span><br><span class="line">                    inst.retransformClasses(clazz);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>agentmain</code>模式和<code>premain</code>的大致写法是没有区别的，最大的区别在于<strong>如果想要利用agentmain模式来对运行后的类进行修改，需要利用Instrumentation.retransformClasses方法来对需要修改的类进行重新转换</strong>。</p>
<p>想要<code>agentmain</code>工作还需要编写一个方法来利用Attach API来动态启动agent：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AttachAgent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException </span>&#123;</span><br><span class="line">        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();</span><br><span class="line">        <span class="keyword">for</span> (VirtualMachineDescriptor vmd : list) &#123;</span><br><span class="line">            <span class="keyword">if</span> (vmd.displayName().endsWith(<span class="string">"TestAgentMain"</span>)) &#123;</span><br><span class="line">                VirtualMachine virtualMachine = VirtualMachine.attach(vmd.id());</span><br><span class="line">                virtualMachine.loadAgent(<span class="string">"/Users/Lucifaer/Dropbox/Code/Java/agentmain_test/out/artifacts/agentmain_test_jar/agentmain_test.jar"</span>, <span class="string">"Attach!"</span>);</span><br><span class="line">                System.out.println(<span class="string">"ok"</span>);</span><br><span class="line">                virtualMachine.detach();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果如下：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15692220517395.jpg" alt=""></p>
<h3 id="3-3-3-agentmain坑点"><a href="#3-3-3-agentmain坑点" class="headerlink" title="3.3.3 agentmain坑点"></a>3.3.3 agentmain坑点</h3><p>这里有一个坑点也导致没有办法在<code>agentmain</code>模式下动态给一个类添加一个新的方法，如果尝试添加一个新的方法就会报错。下面是我编写利用<code>agentmain</code>模式尝试给类动态增加一个方法的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicClassTransformer</span> <span class="keyword">implements</span> <span class="title">ClassFileTransformer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Instrumentation inst;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String descriptor;</span><br><span class="line">    <span class="keyword">private</span> String[] exceptions;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DynamicClassTransformer</span><span class="params">(Instrumentation inst)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.inst = inst;</span><br><span class="line">        inst.addTransformer(<span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="keyword">byte</span>[] classfileBuffer) <span class="keyword">throws</span> IllegalClassFormatException &#123;</span><br><span class="line">        System.out.println(<span class="string">"In transformer"</span>);</span><br><span class="line">        ClassReader cr = <span class="keyword">new</span> ClassReader(classfileBuffer);</span><br><span class="line">        ClassWriter cw = <span class="keyword">new</span> ClassWriter(cr, ClassWriter.COMPUTE_MAXS);</span><br><span class="line">        ClassVisitor cv = <span class="keyword">new</span> ClassVisitor(Opcodes.ASM5, cw) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> i, String s, String s1, String s2, String[] strings)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">final</span> MethodVisitor mv = <span class="keyword">super</span>.visitMethod(i, s, s1, s2, strings);</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"say"</span>.equals(s)) &#123;</span><br><span class="line">                    name = s;</span><br><span class="line">                    descriptor = s1;</span><br><span class="line">                    exceptions = strings;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> mv;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"><span class="comment">//        ClassVisitor cv = new DynamicClassVisitor(Opcodes.ASM5, cw);</span></span><br><span class="line">        cr.accept(cv, ClassReader.EXPAND_FRAMES);</span><br><span class="line">        MethodVisitor mv;</span><br><span class="line">        mv = cw.visitMethod(Opcodes.ACC_PUBLIC, <span class="string">"say2"</span>, <span class="string">"()V"</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        mv.visitCode();</span><br><span class="line">        Label l0 = <span class="keyword">new</span> Label();</span><br><span class="line">        mv.visitLabel(l0);</span><br><span class="line">        mv.visitLineNumber(<span class="number">23</span>, l0);</span><br><span class="line">        mv.visitFieldInsn(Opcodes.GETSTATIC, <span class="string">"java/lang/System"</span>, <span class="string">"out"</span>, <span class="string">"Ljava/io/PrintStream;"</span>);</span><br><span class="line">        mv.visitLdcInsn(<span class="string">"2"</span>);</span><br><span class="line">        mv.visitMethodInsn(Opcodes.INVOKEVIRTUAL, <span class="string">"java/io/PrintStream"</span>, <span class="string">"println"</span>, <span class="string">"(Ljava/lang/String;)V"</span>, <span class="keyword">false</span>);</span><br><span class="line">        Label l1 = <span class="keyword">new</span> Label();</span><br><span class="line">        mv.visitLabel(l1);</span><br><span class="line">        mv.visitLineNumber(<span class="number">24</span>, l1);</span><br><span class="line">        mv.visitInsn(Opcodes.RETURN);</span><br><span class="line">        Label l2 = <span class="keyword">new</span> Label();</span><br><span class="line">        mv.visitLabel(l2);</span><br><span class="line">        mv.visitLocalVariable(<span class="string">"this"</span>, <span class="string">"Lcom/lucifaer/test_agentmain/TestAgentMain;"</span>, <span class="keyword">null</span>, l0, l2, <span class="number">0</span>);</span><br><span class="line">        mv.visitMaxs(<span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line">        mv.visitEnd();</span><br><span class="line">        classfileBuffer = cw.toByteArray();</span><br><span class="line"></span><br><span class="line">        FileOutputStream fos = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fos = <span class="keyword">new</span> FileOutputStream(<span class="string">"agent.class"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">assert</span> fos != <span class="keyword">null</span>;</span><br><span class="line">            fos.write(classfileBuffer);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fos.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> classfileBuffer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">retransform</span><span class="params">()</span> <span class="keyword">throws</span> UnmodifiableClassException </span>&#123;</span><br><span class="line">        LinkedList&lt;Class&gt; retransformClasses = <span class="keyword">new</span> LinkedList&lt;Class&gt;();</span><br><span class="line">        Class[] loadedClasses = inst.getAllLoadedClasses();</span><br><span class="line">        <span class="keyword">for</span> (Class clazz : loadedClasses) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"com.lucifaer.test_agentmain.TestAgentMain"</span>.equals(clazz.getName())) &#123;</span><br><span class="line">                <span class="keyword">if</span> (inst.isModifiableClass(clazz) &amp;&amp; !clazz.getName().startsWith(<span class="string">"java.lang.invoke.LambdaForm"</span>)) &#123;</span><br><span class="line">                    inst.retransformClasses(clazz);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15692252359662.jpg" alt=""></p>
<p>这里尝试添加一个public方法是直接失败的，原因就在于原生的JVM在运行时时为了程序的线程及逻辑安全，禁止向运行时的类添加新的public方法并重新定义该类。JVM默认规则是只能修改方法体中的逻辑，所以这就意味着会有这么一个问题：<strong>当多次attach时，代码会重复插入</strong>，这样是不符合热部署逻辑的。</p>
<p>当然目前市面上也有一定的解决方案，如<a href="https://zeroturnaround.com/software/jrebel/" target="_blank" rel="noopener">JRebel</a>和<a href="https://github.com/spring-projects/spring-loaded" target="_blank" rel="noopener">Spring-Loaded</a>，它们的实现方式是在<code>method call</code>和<code>field access</code>的方法做了一层代理，而这一点对于RASP来说，无疑是加重了部署难度，反而与热部署简单快捷的方式背道而驰。</p>
<h1 id="0x04-OpenRASP的具体实现方式"><a href="#0x04-OpenRASP的具体实现方式" class="headerlink" title="0x04 OpenRASP的具体实现方式"></a>0x04 OpenRASP的具体实现方式</h1><p>以上大致将Java RASP的相关内容介绍完毕后，这部分来深入了解一下OpenRASP的Java RASP这一部分是怎么写的，执行流是如何。</p>
<h2 id="4-1-OpenRASP执行流"><a href="#4-1-OpenRASP执行流" class="headerlink" title="4.1 OpenRASP执行流"></a>4.1 OpenRASP执行流</h2><p>OpenRASP的执行流很简单主要分为以下几部分：</p>
<ol>
<li>agent初始化</li>
<li>V8引擎初始化</li>
<li>日志配置模块初始化</li>
<li>插件模块初始化</li>
<li>hook点管理模块初始化</li>
<li>字节码转换模块初始化</li>
</ol>
<p>其中具体实现管理hook点以及添加hook点的部分主要集中于5、6这一部分，这里同样是我们最为关注的地方。</p>
<h2 id="4-2-初始化流程"><a href="#4-2-初始化流程" class="headerlink" title="4.2 初始化流程"></a>4.2 初始化流程</h2><p>在这一部分不会对OpenRASP流程进行一步步的跟踪，只会将其中较为关键的点进行分析。</p>
<h3 id="4-2-1-agent初始化"><a href="#4-2-1-agent初始化" class="headerlink" title="4.2.1 agent初始化"></a>4.2.1 agent初始化</h3><p>通过前面几节的介绍，其实是可以发现RASP类的编写共同点的——其入口就是<code>premain</code>或<code>agentmain</code>方法，这些都会在<code>META-INFO/MANIFEST.MF</code>中标明：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15692311458729.jpg" alt=""></p>
<p>所以其入口就是<code>com.baidu.openrasp.Agent</code>：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15692312237657.jpg" alt=""></p>
<p>这里在模块加载前做了一个非常重要的操作——<strong>将Java agent的jar包加入到BootStrap class path中</strong>，如果不进行特殊设定，则会默认将jar包加入到System class path中，对于研究过类加载机制的朋友们来说一定不陌生，这样做得好处就是可以将jar包加到<code>BootStrapClassLoader</code>所加载的路径中，在类加载时可以保证加载顺序位于最顶层，这样就可以不受到类加载顺序的限制，拦截拦截系统类。</p>
<p>当将jar包添加进BootStrap class path后，就是完成模块加载的初始化流程中，这里会根据指定的jar包来实例化模块加载的主流程：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15692321790464.jpg" alt=""></p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15692321482369.jpg" alt=""></p>
<p>这里的ENGINE_JAR是<code>rasp-engine.jar</code>，也就是源码中的engine模块。这里根据配置文件中的数值通过反射的方式实例化相应的主流程类：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15692326060518.jpg" alt=""></p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15692326391992.jpg" alt=""></p>
<p>然后就可以一目了然的看到模块初始化主流程了：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15692328006619.jpg" alt=""></p>
<p>在主流程中，我们重点关注红框部分，这一部分完成了hook点管理模块初始化，以及字节码转换模块的初始化。</p>
<h3 id="4-2-2-hook点管理模块初始化"><a href="#4-2-2-hook点管理模块初始化" class="headerlink" title="4.2.2 hook点管理模块初始化"></a>4.2.2 hook点管理模块初始化</h3><p>hook点管理的初始化过程非常简单，就是遍历<code>com.baidu.openrasp.plugin.checkerCheckParameter</code>的Type，将其中的元素添加进枚举映射中：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15692345992774.jpg" alt=""></p>
<p>在Type这个枚举类型中，定义了不同类型的攻击类型所对应的检测方式：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15692346834091.jpg" alt=""></p>
<h3 id="4-2-3-字节码转换模块初始化"><a href="#4-2-3-字节码转换模块初始化" class="headerlink" title="4.2.3 字节码转换模块初始化"></a>4.2.3 字节码转换模块初始化</h3><p>字节码转换模块是整个Java RASP的重中之重，OpenRASP是使用的Javassist来操作字节码的，其大致的写法和ASM并无区别，接下来一步步跟进看一下。</p>
<p>在<code>com.baidu.openrasp.EngineBoot#initTransformer</code>中完成了字节码转换模块的初始化：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15692936334997.jpg" alt=""></p>
<p>这里可以看到在实例化了<code>ClassFileTransformer</code>实现的<code>CustomClassTransformer</code>后，调用了一个自己写的<code>retransform</code>方法，在这个方法中对<code>Instrumentation</code>已加载的所有类进行遍历，将其进行类的重新转换：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15692963561020.jpg" alt=""></p>
<p>这里主要是为了支持<code>agentmain</code>模式对类进行重新转换。</p>
<p>在解释完了<code>retranform</code>后，我们来整体看一下OpenRASP是如何添加hook点并完成相应hook流程的。这一部分是在<code>com.baidu.openrasp.transformer#CustomClassTransformer</code>中：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15692935304718.jpg" alt=""></p>
<p>我们都清楚<code>inst.addTransformer</code>的功能是在类加载时做拦截，对输入的类的字节码进行修改，也就是具体的检测流程插入都在这一部分。但是OpenRASP的hook点是在哪里加入的呢？其实就是在<code>addAnnotationHook</code>这里完成的：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693148353863.jpg" alt=""></p>
<p>这里会到<code>com.baidu.openrasp.hook</code>下对所有的类进行扫描，将所有由<code>HookAnnotation</code>注解的类全部加入到<code>HashSet</code>中，例如OgnlHook：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693150496091.jpg" alt=""></p>
<p>至此就完成了字节码转换模块的初始化。</p>
<h2 id="4-3-类加载拦截流程"><a href="#4-3-类加载拦截流程" class="headerlink" title="4.3 类加载拦截流程"></a>4.3 类加载拦截流程</h2><p>前文已经介绍过RASP的具体拦截流程是在<code>ClassFileTransformer#transform</code>中完成的，在OpenRASP中则是在<code>CustomClassTransformer#transform</code>中完成的：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693194804204.jpg" alt=""></p>
<p>可以看到先检测当前拦截类是否为已经注册的需要hook的类，如果是hook的类则直接利用javassist的方式创建<code>ctClass</code>，想要具体了解javassist的使用方式的同学，可以直接看javassist的官方文档，这里不再过多表述。</p>
<p>可以看到在创建完<code>ctClass</code>后，直接调用了当前hook的<code>transformClass</code>方法。由于接下来涉及到跟进具体的hook处理类中，所以接下来的分析是以跟进<code>OgnlHook</code>这个hook来跟进的。</p>
<p><code>OgnlHook</code>是继承于<code>AbstractClassHook</code>的，在<code>AbstractClassHook</code>中预定义了很多虚方法，同时也提供了很多通用的方法，<code>transformClass</code>方法就是在这里定义的：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693198460598.jpg" alt=""></p>
<p>这里直接调用了每个具体hook类的<code>hookMethod</code>方法来执行具体的逻辑，值得注意的是这里的最终返回也是一个<code>byte</code>数组，具体的流程和ASM并无两样。跟进<code>OgnlHook#hookMethod</code>：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693199760579.jpg" alt=""></p>
<p>这里首先生成需要插入到代码中的字节码，然后调用其自己写的<code>inserAfter</code>来将字节码插入到hook点的后面（其实就是决定是插在hook方法最顶部，还是return前的最后一行，这决定了调用顺序）。</p>
<p>可以简单的看一下插入的字节码是如何生成的：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693203131952.jpg" alt=""></p>
<p>很简单，就是插入一段代码，这段代码将反射实例化当前hook类，调用<code>methodName</code>所指定的方法，并将<code>paramString</code>所指定的参数传入该方法中。所以接下来看一下<code>OgnlHook#checkOgnlExpression</code>方法所执行的逻辑：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693205652450.jpg" alt=""></p>
<p>判断获取的表达式是不是<code>String</code>类型，如果是，将表达式放入<code>HashMap</code>中，然后调用<code>HookHandler.doCheck</code>方法：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693206710905.jpg" alt=""></p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693206924482.jpg" alt=""></p>
<p>在这里说一句题外话，可以看到在这里的逻辑设定是当服务器cpu使用率超过90%时，禁用全部的hook点。这也是RASP要思考解决的一个问题，当负载过高时，一定要给业务让步，也就一定要停止防护功能，不然会引发oom，直接把业务搞崩。所以如何尽量的减少资源占用也是RASP需要解决的一个大问题。</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693209819777.jpg" alt=""></p>
<p>这里就是检测的主要逻辑，主要完成：</p>
<ul>
<li>检测计时</li>
<li>获取检测结果</li>
<li>根据检测结果判断是否要进行拦截</li>
</ul>
<p>具体看一下如何获取的检测结果：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693210594055.jpg" alt=""></p>
<p>这里的<code>checkers</code>是在hook点管理模块初始化时设置的枚举类映射，所以这里调用的是：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693211779876.jpg" alt=""></p>
<p><code>V8Checker().check()</code>方法，继承树如下：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693213086308.jpg" alt=""></p>
<p>所以具体的实现是在<code>AbstractChecker#check</code>中：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693213753323.jpg" alt=""></p>
<p>也就是<code>V8Checker#checkParam</code>：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693214246792.jpg" alt=""></p>
<p>这里就一目了然了，是调用JS插件来完成检测的：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693216185113.jpg" alt=""></p>
<p>easygame，就是在JS插件（其实就是个js文件）中寻找相应的规则进行规则匹配。这个js文件在<code>OpenRASP根目录/plugins/official/plugin.js</code>中：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693218880207.jpg" alt=""></p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693221211184.jpg" alt=""></p>
<p>如果符合匹配规则则返回block，完成攻击拦截。</p>
<p>至此整个拦截流程分析完毕。</p>
<h2 id="4-4-小结"><a href="#4-4-小结" class="headerlink" title="4.4 小结"></a>4.4 小结</h2><p>从上面的分析中可以看出OpenRASP的实现方式还是比较简单的，其中非常有创新点的是利用js来编写规则，通过V8来执行js。<strong>利用js来编写规则的好处是更加方便热部署以及规则的通用性，同时减少了为不同语言重复制定相同规则的问题</strong>。</p>
<p>同样，OpenRASP也不免存在RASP本身存在的一些缺陷，这些缺陷将在“缺陷思考”这一节中具体的描述。</p>
<h1 id="0x05-缺陷思考"><a href="#0x05-缺陷思考" class="headerlink" title="0x05 缺陷思考"></a>0x05 缺陷思考</h1><p>虽然Java RASP是以Java Instrumentation的工作方式工作在JVM层，可以通过hook引发漏洞的关键函数，在关键函数前添加安全检查，这看上去像是一个“all in one”的通用解，但是其实存在很多问题。</p>
<h2 id="5-1-“通用解”的通用问题"><a href="#5-1-“通用解”的通用问题" class="headerlink" title="5.1 “通用解”的通用问题"></a>5.1 “通用解”的通用问题</h2><p><strong>所有“通用解”的最大问题都出现在通用性上</strong>。在真实场景中RASP的应用环境比其在实验环境中复杂的多，如果想要一个RASP真正的运行在业务上就需要从乙方和甲方的角度双向思考问题，以下是我想到的一些问题，可能有些偏颇，但是还是希望能给一些参考性的意见：</p>
<h3 id="5-1-1-语言环境的通配适用性"><a href="#5-1-1-语言环境的通配适用性" class="headerlink" title="5.1.1 语言环境的通配适用性"></a>5.1.1 语言环境的通配适用性</h3><p>企业内部的web应用纷繁复杂，有用Java编写的应用，有用Go编写的，还有用PHP、Python写的等等…，那么如何对这些不同语言所构建的应用程序都实现相应的防护？</p>
<p>对于甲方来说，我购置一套安全防护产品肯定是要能起到通用防护的作用的，肯定不会只针对Java购进一套Java RASP，这样做未免也太亏了。</p>
<p>对于乙方来说，每一种语言都有不同的特性，都要用不同的方式构建RASP，对于开发和安全研究人员来说工作量是相当之大的，强如OpenRASP团队目前也只是支持PHP和Java两个版本的。</p>
<p>这很大程度上也是影响到RASP推广的一个原因。看看传统的WAF、旁路流量监测等产品，它并不受语言的限制，只关心流量中是否存在具有威胁的流量就好，巧妙的减少了一个变量，从而加强了泛用性，无论什么样的环境都可以快速部署发挥作用，对于企业来说，肯定是更愿意购入WAF的。</p>
<h3 id="5-1-2-部署的通配适用性"><a href="#5-1-2-部署的通配适用性" class="headerlink" title="5.1.2 部署的通配适用性"></a>5.1.2 部署的通配适用性</h3><p>由于开发人员所擅长的技能不同或不同项目组的技能树设定的不同，企业内部往往会存在使用各种各样框架实现的代码。而在代码部署上，如果没有一开始就制定严格的规范的话，部署环境也会存在各种各样的情况。就拿Java来说，企业内部可能存在Struts2写的、Spring写的、RichFaces写的等等…，同时这些应用可能部署在不同的中间件上：Tomcat、Weblogic、JBoss、Websphere等等…，不同的框架，不同的中间件部署方式都或多或少的有所不同，想要实现通配，真的不容易。</p>
<h3 id="5-1-3-规则的通用性"><a href="#5-1-3-规则的通用性" class="headerlink" title="5.1.3 规则的通用性"></a>5.1.3 规则的通用性</h3><p>这一点其实已经被OpenRASP较好的解决了，统一利用js做规则，然后利用js引擎解析规则。所以这一点不多赘述。</p>
<h2 id="5-2-自身稳定性的问题"><a href="#5-2-自身稳定性的问题" class="headerlink" title="5.2 自身稳定性的问题"></a>5.2 自身稳定性的问题</h2><p>“安全产品首先要保证自己是安全的”，这句话说出来感觉是比较搞笑的，但是往往很多的安全产品其自身安全性就很差，只是仗着黑盒的不确定性才保持自己的神秘感罢了。对于RASP来说这句话更是需要严格奉行。因为RASP是将检测逻辑插入到hook点中的，只要到达了相应的hook点，检测逻辑是一定会被执行的，如果这个时候RASP实现的检测逻辑本身出现了问题，严重的话会导致整个业务崩溃，或直接被打穿。</p>
<h3 id="5-2-1-执行逻辑稳定性"><a href="#5-2-1-执行逻辑稳定性" class="headerlink" title="5.2.1 执行逻辑稳定性"></a>5.2.1 执行逻辑稳定性</h3><p>就像上文所说的一样，如果在RASP所执行的逻辑中出现了严重的错误，将会直接将错误抛出在业务逻辑中，轻则当前业务中断，重则整个服务中断，这对于甲方来说就是严重的事故，甚至比服务器被攻击还严重。</p>
<p>简单来举个例子（当然在真实写RASP的时候不会这么写，这里只是展示严重性），如果在RASP的检测逻辑中存在<code>exit()</code>这样的利用，将直接导致程序退出：</p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693833968474.jpg" alt=""></p>
<p><img src="http://image-lucifaer.test.upcdn.net/2019/09/25/15693834303108.jpg" alt=""></p>
<p>这也就是为什么很多甲方并不喜欢RASP这种方式，因为归根到底，RASP还是将代码插入到业务执行流中，不出问题还好，出了问题就会影响业务。相比来说，WAF最多就是误封，但是并不会down掉业务，稳定性上是有一定保障的。</p>
<h3 id="5-2-2-自身安全稳定性"><a href="#5-2-2-自身安全稳定性" class="headerlink" title="5.2.2 自身安全稳定性"></a>5.2.2 自身安全稳定性</h3><p>试想一个场景，如果RASP本身存在一定的漏洞，那是不是相当的可怕？即使原来的应用是没有明显的安全威胁的，但是在RASP处理过程中存在漏洞，而恰巧攻击者传入一个利用这样漏洞的payload，将直接在RASP处理流中完成触发。</p>
<p>举个实际的例子，比如在RASP中使用了受漏洞影响的FastJson库来处理相应的json数据，那么当攻击者在发送FastJson反序列化攻击payload的时候就会造成目标系统被RCE。</p>
<p>这其实并不是一个危言耸听的例子，OpenRASP在某版本使用的就是FastJson来处理json字符串，而当时的FastJson版本就是存在漏洞的版本。所以在最新的OpenRASP中，统一使用了较为安全的Gson来处理json字符串。</p>
<p>RASP的处理思路就决定了其与业务是联系非常紧密的，可以说就是业务的“一部分”，所以如果RASP自己的代码不规范不安全，最终将导致直接给业务写了一个漏洞。</p>
<h3 id="5-2-3-规则的稳定性"><a href="#5-2-3-规则的稳定性" class="headerlink" title="5.2.3 规则的稳定性"></a>5.2.3 规则的稳定性</h3><p>RASP的规则是需要经过专业的安全研究人员反复打磨并且根据业务来定制化的，需要尽量将所有的可能性都考虑进去，同时尽量的减少误报。但是由于规则贡献者水平的参差不齐，很容易导致规则遗漏，从而根本无法拦截相关的攻击，或产生大量的攻击误报。这样对于甲方来说无疑是一笔稳赔的买卖——花费大量时间进行部署，花费大量服务器资源来启用RASP，最终的安全效果却还是不尽如人意。</p>
<p>如果想要尽量的完善规则，只能更加贴近业务场景，针对不同的情况做不同的规则判别。所以说规则和业务场景是分不开的，对乙方来说不深入开发、不深入客户是很难做好安全产品的，如果只是停留在实验阶段，是永远没有办法向工程化和产品化转换的。</p>
<h2 id="5-3-部署复杂性的问题"><a href="#5-3-部署复杂性的问题" class="headerlink" title="5.3 部署复杂性的问题"></a>5.3 部署复杂性的问题</h2><p>在0x03以及0x04中不难看理想中最佳的Java RASP实践方式是使用<code>agentmain</code>模式进行无侵入部署，但是受限于JVM进程保护机制没有办法对目标类添加新的方法，所以就会造成多次attach造成的重复字节码插入的问题。目前主流的Java RASP推荐的部署方式都是利用<code>premain</code>模式进行部署，这就造成了必须停止相关业务，加入相应的启动参数，再开启服务这么一个复杂的过程。</p>
<p>对于甲方来说，重启一次业务完成部署RASP的代价是比较高的，所以都是不愿意采取这样的方案的。而且在甲方企业内部存在那么多的服务，一台台部署显然也是不现实的。目前所提出的自动化部署方案也受限于实际业务场景的复杂性，并不稳定。</p>
<h1 id="0x06-总结"><a href="#0x06-总结" class="headerlink" title="0x06 总结"></a>0x06 总结</h1><p>就目前来说RASP解决方案已经相对成熟，除非JDK出现新的特性，否则很难出现重大的革新。</p>
<p>目前各家RASP厂商主要都是针对性能及其他的辅助功能进行开发和优化，比如OpenRASP提出了用RASP构建SIEM以及实现被动扫描器的思路，这其实是一个非常好的思路，RASP配合被动扫描器能很方便的对企业内部的资产进行扫描，从而实现一定程度上的漏洞管控。</p>
<p>但是RASP不是万能的，并不能高效的防御所有的漏洞，其优劣势是非常明显的，应当正确的理解RASP本身的司职联合其他的防御措施构建完整的防御体系才能更好的做好安全防护。</p>
<p>个人认为RASP的最佳实践场所是甲方内部，甲方可以通过资产梳理对不同的系统进行相应的流量管控，这样RASP就能大大减少泛性检测所带来的的误报，同时更进一步的增加应用的安全性。</p>
<p>总体来说RASP是未来Web应用安全防护的方向，也同时是一个Web安全的发展趋势，其相较于传统安全防护产品的优势是不言而喻的，只要解决泛用性、稳定性、部署难等问题，可以说是目前能想出的一种较为理想方案了。</p>
<h1 id="0x07-Reference"><a href="#0x07-Reference" class="headerlink" title="0x07 Reference"></a>0x07 Reference</h1><ul>
<li><a href="https://asm.ow2.io/asm4-guide.pdf" target="_blank" rel="noopener">https://asm.ow2.io/asm4-guide.pdf</a></li>
<li><a href="https://github.com/anbai-inc/javaweb-expression" target="_blank" rel="noopener">https://github.com/anbai-inc/javaweb-expression</a></li>
<li><a href="https://github.com/Lucifaer/head_first_javarasp/tree/el_expression_hook" target="_blank" rel="noopener">https://github.com/Lucifaer/head_first_javarasp/tree/el_expression_hook</a></li>
<li><a href="https://zeroturnaround.com/software/jrebel/" target="_blank" rel="noopener">https://zeroturnaround.com/software/jrebel/</a></li>
<li><a href="https://github.com/spring-projects/spring-loaded" target="_blank" rel="noopener">https://github.com/spring-projects/spring-loaded</a></li>
<li><a href="https://github.com/baidu/openrasp" target="_blank" rel="noopener">https://github.com/baidu/openrasp</a></li>
<li><a href="https://rasp.baidu.com/doc/" target="_blank" rel="noopener">https://rasp.baidu.com/doc/</a></li>
<li><a href="http://www.fanyilun.me/2017/07/18/%e8%b0%88%e8%b0%88Java%20Intrumentation%e5%92%8c%e7%9b%b8%e5%85%b3%e5%ba%94%e7%94%a8/" target="_blank" rel="noopener">http://www.fanyilun.me/2017/07/18/%e8%b0%88%e8%b0%88Java%20Intrumentation%e5%92%8c%e7%9b%b8%e5%85%b3%e5%ba%94%e7%94%a8/</a></li>
</ul>

    </article>
    <!-- license  -->
    
        <div class="license-wrapper">
            <p>原文作者: <a href="https://lucifaer.com">Lucifaer</a>
            <p>原文链接: <a href="https://lucifaer.com/2019/09/25/浅谈RASP/">https://lucifaer.com/2019/09/25/浅谈RASP/</a>
            <p>发表日期: <a href="https://lucifaer.com/2019/09/25/浅谈RASP/">September 25th 2019, 4:32:00 pm</a>
            <p>版权声明: 本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
        </div>
    
    <!-- paginator  -->
    <ul class="post-paginator">
        <li class="next">
            
                <div class="nextSlogan">Next Post</div>
                <a href= "/2020/02/20/Java CORBA研究/" title= Java CORBA研究 >
                    <div class="nextTitle">Java CORBA研究</div>
                </a>
            
        </li>
        <li class="previous">
            
                <div class="prevSlogan">Previous Post</div>
                <a href= "/2019/07/24/Fastjson 流程分析及RCE分析/" title= Fastjson 流程分析及RCE分析 >
                    <div class="prevTitle">Fastjson 流程分析及RCE分析</div>
                </a>
            
        </li>
    </ul>
    <!-- 评论插件 -->
    <!-- 来必力City版安装代码 -->

    <div id="lv-container" data-id="city" data-uid= MTAyMC8zODcyOC8xNTI1Ng==>
        <script type="text/javascript">
            (function(d, s) {
                var j, e = d.getElementsByTagName(s)[0];
         
                if (typeof LivereTower === 'function') { return; }
         
                j = d.createElement(s);
                j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
                j.async = true;
         
                e.parentNode.insertBefore(j, e);
            })(document, 'script');
             </script>
         <noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
    </div>

<!-- City版安装代码已完成 -->
    
    
    <!--PC和WAP自适应版-->

    <!--PC版-->


    
    

    <!-- 评论 -->
</main>
            <!-- profile -->
            
        </div>
        <footer class="footer footer-unloaded">
    <!-- social  -->
    
    <div class="social">
        
    
        
            
                <a href="mailto:l.lucifaer@gmail.com" class="iconfont-archer email" title=email ></a>
            
        
    
        
            
                <a href="//github.com/Lucifaer" class="iconfont-archer github" target="_blank" title=github></a>
            
        
    
        
    
        
    
        
            
                <a href="//weibo.com/5838222069" class="iconfont-archer weibo" target="_blank" title=weibo></a>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
            
                <a href="/atom.xml" class="iconfont-archer rss" target="_blank" title=rss></a>
            
        
    

    </div>
    
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- 不蒜子  -->
    
    <div class="busuanzi-container">
    
     
    <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
    
    </div>
    
</footer>
    </div>
    <!-- toc -->
    
    <div class="toc-wrapper" style=
    







top:50vh;

    >
        <div class="toc-catalog">
            <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
        </div>
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-概述"><span class="toc-number">1.</span> <span class="toc-text">0x01 概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-Java-RASP技术栈"><span class="toc-number">2.</span> <span class="toc-text">0x02 Java RASP技术栈</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-Java-RASP实现方式"><span class="toc-number">3.</span> <span class="toc-text">0x03 Java RASP实现方式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-Java-Agent简介"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 Java Agent简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-ASM简介"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 ASM简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-1-访问者模式"><span class="toc-number">3.2.0.1.</span> <span class="toc-text">3.2.1 访问者模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2-2-ASM的访问者模式"><span class="toc-number">3.2.0.2.</span> <span class="toc-text">3.2.2 ASM的访问者模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-实际例子"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 实际例子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-1-premain模式例子"><span class="toc-number">3.3.1.</span> <span class="toc-text">3.3.1 premain模式例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-2-agentmain模式例子"><span class="toc-number">3.3.2.</span> <span class="toc-text">3.3.2 agentmain模式例子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-3-agentmain坑点"><span class="toc-number">3.3.3.</span> <span class="toc-text">3.3.3 agentmain坑点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-OpenRASP的具体实现方式"><span class="toc-number">4.</span> <span class="toc-text">0x04 OpenRASP的具体实现方式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-OpenRASP执行流"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 OpenRASP执行流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-初始化流程"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 初始化流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-1-agent初始化"><span class="toc-number">4.2.1.</span> <span class="toc-text">4.2.1 agent初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-2-hook点管理模块初始化"><span class="toc-number">4.2.2.</span> <span class="toc-text">4.2.2 hook点管理模块初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-3-字节码转换模块初始化"><span class="toc-number">4.2.3.</span> <span class="toc-text">4.2.3 字节码转换模块初始化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-类加载拦截流程"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 类加载拦截流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-小结"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 小结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-缺陷思考"><span class="toc-number">5.</span> <span class="toc-text">0x05 缺陷思考</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-“通用解”的通用问题"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 “通用解”的通用问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-1-语言环境的通配适用性"><span class="toc-number">5.1.1.</span> <span class="toc-text">5.1.1 语言环境的通配适用性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-2-部署的通配适用性"><span class="toc-number">5.1.2.</span> <span class="toc-text">5.1.2 部署的通配适用性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-3-规则的通用性"><span class="toc-number">5.1.3.</span> <span class="toc-text">5.1.3 规则的通用性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-自身稳定性的问题"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 自身稳定性的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-1-执行逻辑稳定性"><span class="toc-number">5.2.1.</span> <span class="toc-text">5.2.1 执行逻辑稳定性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-2-自身安全稳定性"><span class="toc-number">5.2.2.</span> <span class="toc-text">5.2.2 自身安全稳定性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-3-规则的稳定性"><span class="toc-number">5.2.3.</span> <span class="toc-text">5.2.3 规则的稳定性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-部署复杂性的问题"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 部署复杂性的问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-总结"><span class="toc-number">6.</span> <span class="toc-text">0x06 总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-Reference"><span class="toc-number">7.</span> <span class="toc-text">0x07 Reference</span></a></li></ol>
    </div>
    
    <div class="back-top iconfont-archer">&#xe639;</div>
    <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
          <div class="sidebar-panel-archives">
    <!-- 在ejs中将archive按照时间排序 -->
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 40
        </div>
        <!-- search  -->
        
            <div class="site-search popup-trigger">
                <span class="iconfont-archer search-icon">&#xe627;</span>
            </div>
        
    </div>
    
    <div class="post-archive">
    
    
    
    
    <div class="archive-year"> 2020 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/12</span><a class="archive-post-title" href= "/2020/05/12/Tomcat通用回显学习/" >Tomcat通用回显学习</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/10</span><a class="archive-post-title" href= "/2020/03/10/Oracle Coherence 反序列化漏洞分析（CVE-2020-2555）/" >Oracle Coherence 反序列化漏洞分析（CVE-2020-2555）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/25</span><a class="archive-post-title" href= "/2020/02/25/WebLogic WLS核心组件RCE分析（CVE-2020-2551）/" >WebLogic WLS核心组件RCE分析（CVE-2020-2551）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/20</span><a class="archive-post-title" href= "/2020/02/20/Java CORBA研究/" >Java CORBA研究</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2019 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">09/25</span><a class="archive-post-title" href= "/2019/09/25/浅谈RASP/" >浅谈RASP</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/24</span><a class="archive-post-title" href= "/2019/07/24/Fastjson 流程分析及RCE分析/" >Fastjson 流程分析及RCE分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/10</span><a class="archive-post-title" href= "/2019/05/10/WebLogic wls9-async组件RCE分析（CVE-2019-2725）/" >WebLogic wls9-async组件RCE分析（CVE-2019-2725）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/19</span><a class="archive-post-title" href= "/2019/04/19/Confluence 路径穿越漏洞分析（CVE-2019-3398）/" >Confluence 路径穿越漏洞分析（CVE-2019-3398）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/16</span><a class="archive-post-title" href= "/2019/04/16/Confluence 未授权RCE分析（CVE-2019-3396）/" >Confluence 未授权RCE分析（CVE-2019-3396）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/13</span><a class="archive-post-title" href= "/2019/03/13/Attack Spring Boot Actuator via jolokia Part 2/" >Attack Spring Boot Actuator via jolokia Part 2</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/11</span><a class="archive-post-title" href= "/2019/03/11/Attack Spring Boot Actuator via jolokia Part 1/" >Attack Spring Boot Actuator via jolokia Part 1</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/04</span><a class="archive-post-title" href= "/2019/03/04/Jenkins RCE分析（CVE-2018-1000861分析）/" >Jenkins RCE分析（CVE-2018-1000861分析）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/19</span><a class="archive-post-title" href= "/2019/02/19/Nexus Repository Manager 3 远程代码执行漏洞分析（CVE-2019-7238）/" >Nexus Repository Manager 3 远程代码执行漏洞分析（CVE-2019-7238）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/16</span><a class="archive-post-title" href= "/2019/01/16/浅析OGNL的攻防史/" >浅析OGNL的攻防史</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2018 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/25</span><a class="archive-post-title" href= "/2018/12/25/S2-057（CVE-2018-11776）流程分析/" >S2-057（CVE-2018-11776）流程分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/17</span><a class="archive-post-title" href= "/2018/12/17/S2-046（CVE-2017-5638）分析/" >S2-046（CVE-2017-5638）分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/14</span><a class="archive-post-title" href= "/2018/12/14/如何解决Pyppeteer的Target closed错误/" >如何解决Pyppeteer的Target closed错误</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/12</span><a class="archive-post-title" href= "/2018/12/12/S2-045（CVE-2017-5638）分析/" >S2-045（CVE-2017-5638）分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">12/05</span><a class="archive-post-title" href= "/2018/12/05/RF-14310（CVE-2018-12533）分析/" >RF-14310（CVE-2018-12533）分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">11/29</span><a class="archive-post-title" href= "/2018/11/29/JBoss RichFaces Unserialize+EL=RCE Analysis（CVE-2018-14667）/" >JBoss RichFaces Unserialize+EL=RCE Analysis（CVE-2018-14667）</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/30</span><a class="archive-post-title" href= "/2018/08/30/phpMyAdmin <= 4.7.7 CSRF分析/" >phpMyAdmin <= 4.7.7 CSRF分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/29</span><a class="archive-post-title" href= "/2018/08/29/Discuz! 1.5-2.5 命令执行漏洞分析(CVE-2018-14729)/" >Discuz! 1.5-2.5 命令执行漏洞分析(CVE-2018-14729)</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/13</span><a class="archive-post-title" href= "/2018/08/13/MySQLi Cookbook/" >MySQLi Cookbook</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/19</span><a class="archive-post-title" href= "/2018/07/19/薅羊毛产业链分析/" >薅羊毛产业链分析</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/18</span><a class="archive-post-title" href= "/2018/06/18/以太坊简介/" >以太坊简介</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/18</span><a class="archive-post-title" href= "/2018/06/18/比特币简介/" >比特币简介</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/18</span><a class="archive-post-title" href= "/2018/06/18/区块链补充/" >区块链补充</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">06/18</span><a class="archive-post-title" href= "/2018/06/18/区块链基础概念/" >区块链基础概念</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">03/02</span><a class="archive-post-title" href= "/2018/03/02/部署Django/" >部署Django</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/28</span><a class="archive-post-title" href= "/2018/02/28/Git Hooks实现项目的自动部署/" >Git Hooks实现项目的自动部署</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2017 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">10/09</span><a class="archive-post-title" href= "/2017/10/09/XDCTF Upload 引发出来的一个新思路/" >XDCTF Upload 引发出来的一个新思路</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/20</span><a class="archive-post-title" href= "/2017/07/20/Blackhat SEO/" >Blackhat SEO</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">07/19</span><a class="archive-post-title" href= "/2017/07/19/PHP反序列化漏洞/" >PHP反序列化漏洞</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/27</span><a class="archive-post-title" href= "/2017/05/27/Joomla 框架的简单跟进/" >Joomla 框架的简单跟进</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">05/09</span><a class="archive-post-title" href= "/2017/05/09/五指CMS任意文件下载漏洞/" >五指CMS任意文件下载漏洞</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">04/13</span><a class="archive-post-title" href= "/2017/04/13/Phpcms V9.6.0任意文件写入getshell/" >Phpcms V9.6.0任意文件写入getshell</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/06</span><a class="archive-post-title" href= "/2017/02/06/WordPress REST API 内容注入/" >WordPress REST API 内容注入</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/18</span><a class="archive-post-title" href= "/2017/01/18/SugarCRM v6.5.23 PHP反序列化对象注入漏洞分析/" >SugarCRM v6.5.23 PHP反序列化对象注入漏洞分析</a>
        </li>
    
    
    
    
    
        </ul>
    
    <div class="archive-year"> 2016 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/11</span><a class="archive-post-title" href= "/2016/08/11/CVE-2016-6483 vBulletin 5.2.2 SSRF漏洞/" >CVE-2016-6483 vBulletin 5.2.2 SSRF漏洞</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">08/09</span><a class="archive-post-title" href= "/2016/08/09/IPS Community Suite 自动加载的PHP代码注入漏洞（CVE-2016-6174）/" >IPS Community Suite 自动加载的PHP代码注入漏洞（CVE-2016-6174）</a>
        </li>
    
    </div>
  </div>
        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
    
        <span class="sidebar-tag-name" data-tags="漏洞分析"><span class="iconfont-archer">&#xe606;</span>漏洞分析</span>
    
        <span class="sidebar-tag-name" data-tags="Java"><span class="iconfont-archer">&#xe606;</span>Java</span>
    
        <span class="sidebar-tag-name" data-tags="Spring"><span class="iconfont-archer">&#xe606;</span>Spring</span>
    
        <span class="sidebar-tag-name" data-tags="jolokia"><span class="iconfont-archer">&#xe606;</span>jolokia</span>
    
        <span class="sidebar-tag-name" data-tags="黑产研究"><span class="iconfont-archer">&#xe606;</span>黑产研究</span>
    
        <span class="sidebar-tag-name" data-tags="BlackHat SEO"><span class="iconfont-archer">&#xe606;</span>BlackHat SEO</span>
    
        <span class="sidebar-tag-name" data-tags="Confluence"><span class="iconfont-archer">&#xe606;</span>Confluence</span>
    
        <span class="sidebar-tag-name" data-tags="PHP"><span class="iconfont-archer">&#xe606;</span>PHP</span>
    
        <span class="sidebar-tag-name" data-tags="Git"><span class="iconfont-archer">&#xe606;</span>Git</span>
    
        <span class="sidebar-tag-name" data-tags="环境部署"><span class="iconfont-archer">&#xe606;</span>环境部署</span>
    
        <span class="sidebar-tag-name" data-tags="FastJson"><span class="iconfont-archer">&#xe606;</span>FastJson</span>
    
        <span class="sidebar-tag-name" data-tags="RichFaces"><span class="iconfont-archer">&#xe606;</span>RichFaces</span>
    
        <span class="sidebar-tag-name" data-tags="Jenkins"><span class="iconfont-archer">&#xe606;</span>Jenkins</span>
    
        <span class="sidebar-tag-name" data-tags="CookBook"><span class="iconfont-archer">&#xe606;</span>CookBook</span>
    
        <span class="sidebar-tag-name" data-tags="SQL注入"><span class="iconfont-archer">&#xe606;</span>SQL注入</span>
    
        <span class="sidebar-tag-name" data-tags="安全研究"><span class="iconfont-archer">&#xe606;</span>安全研究</span>
    
        <span class="sidebar-tag-name" data-tags="Joomla"><span class="iconfont-archer">&#xe606;</span>Joomla</span>
    
        <span class="sidebar-tag-name" data-tags="Nexuss"><span class="iconfont-archer">&#xe606;</span>Nexuss</span>
    
        <span class="sidebar-tag-name" data-tags="Weblogic"><span class="iconfont-archer">&#xe606;</span>Weblogic</span>
    
        <span class="sidebar-tag-name" data-tags="Tomcat"><span class="iconfont-archer">&#xe606;</span>Tomcat</span>
    
        <span class="sidebar-tag-name" data-tags="回显方案"><span class="iconfont-archer">&#xe606;</span>回显方案</span>
    
        <span class="sidebar-tag-name" data-tags="Struts2"><span class="iconfont-archer">&#xe606;</span>Struts2</span>
    
        <span class="sidebar-tag-name" data-tags="CTF"><span class="iconfont-archer">&#xe606;</span>CTF</span>
    
        <span class="sidebar-tag-name" data-tags="blockchain"><span class="iconfont-archer">&#xe606;</span>blockchain</span>
    
        <span class="sidebar-tag-name" data-tags="Python"><span class="iconfont-archer">&#xe606;</span>Python</span>
    
        <span class="sidebar-tag-name" data-tags="薅羊毛"><span class="iconfont-archer">&#xe606;</span>薅羊毛</span>
    
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
    缺失模块。<br/>
    1、请确保node版本大于6.2<br/>
    2、在博客根目录（注意不是archer根目录）执行以下命令：<br/>
    <span style="color: #f75357; font-size: 1rem; line-height: 2rem;">npm i hexo-generator-json-content --save</span><br/>
    3、在根目录_config.yml里添加配置：
    <pre style="color: #787878; font-size: 0.6rem;">
jsonContent:
  meta: false
  pages: false
  posts:
    title: true
    date: true
    path: true
    text: false
    raw: false
    content: false
    slug: false
    updated: false
    comments: false
    link: false
    permalink: false
    excerpt: false
    categories: true
    tags: true</pre>
    </div> 
    <div class="sidebar-tags-list"></div>
</div>
        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
        <span class="sidebar-category-name" data-categories="漏洞分析"><span class="iconfont-archer">&#xe60a;</span>漏洞分析</span>
    
        <span class="sidebar-category-name" data-categories="黑产研究"><span class="iconfont-archer">&#xe60a;</span>黑产研究</span>
    
        <span class="sidebar-category-name" data-categories="环境部署"><span class="iconfont-archer">&#xe60a;</span>环境部署</span>
    
        <span class="sidebar-category-name" data-categories="技术总结"><span class="iconfont-archer">&#xe60a;</span>技术总结</span>
    
        <span class="sidebar-category-name" data-categories="安全研究"><span class="iconfont-archer">&#xe60a;</span>安全研究</span>
    
        <span class="sidebar-category-name" data-categories="一些思路"><span class="iconfont-archer">&#xe60a;</span>一些思路</span>
    
        <span class="sidebar-category-name" data-categories="blockchain"><span class="iconfont-archer">&#xe60a;</span>blockchain</span>
    
        <span class="sidebar-category-name" data-categories="Python"><span class="iconfont-archer">&#xe60a;</span>Python</span>
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>
    </div>
</div> 
    <script>
    var siteMeta = {
        root: "/",
        author: "Lucifaer"
    }
</script>
    <!-- CDN failover -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ === 'undefined')
        {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js">\x3C/script>')
        }
    </script>
    <script src="/scripts/main.js"></script>
    <!-- algolia -->
    
        <div class="site-search">
  <div class="algolia-popup popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="iconfont-archer">&#xe609;</i>
    </span>
  </div>
</div>
        <script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.8.0/dist/instantsearch.min.js" defer></script>
        <script src="/scripts/search.js" defer></script>
    
    <!-- busuanzi  -->
    
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    <!-- CNZZ  -->
    
    </div>
    <!-- async load share.js -->
    
        <script src="/scripts/share.js" async></script>    
     
    </body>
</html>


